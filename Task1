#!/bin/bash

# Path to the CSV file
CSV_FILE="/mnt/data/users.csv"

# Read the CSV file line by line
while IFS=, read -r email birth_date groups shared_folder
do
    # Skip the header line
    if [[ "$email" == "email" ]]; then
        continue
    fi

    # Extract username from email
    username=$(echo $email | cut -d'@' -f1)

    # Set password based on birth date
    password=$(echo $birth_date | tr -d '-')

    # Create user and set password
    sudo useradd -m -s /bin/bash "$username"
    echo "$username:$password" | sudo chpasswd

    # Set up user groups
    IFS=';' read -ra group_array <<< "$groups"
    for group in "${group_array[@]}"; do
        sudo usermod -aG "$group" "$username"
    done

    # Create shared folder and set permissions
    sudo mkdir -p "$shared_folder"
    sudo chown "$username":"$username" "$shared_folder"
    sudo chmod 700 "$shared_folder"

    echo "User $username created and configured."
done < "$CSV_FILE"
